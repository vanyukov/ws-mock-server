# Варианты работы

## Запустить ws сервер и отдавать моки

`npm run start`

### Файлы с моками для раздачи

Отдаются файлы из папки `src/mock_overrides/downloaded` или `src/mock`

1. `src/mock_overrides/downloaded` - сначала ищет файл здесь. В эту папку сохраняются файлы командой `npm run loadMocks`
1. `src/mock`- если файл не найден в п.1 ищет здесь - это данные по умолчанию

Структура папок одинакова:

1. первый уровень вложенности - номер подписки `t` из входящего сообщения

1. второй уровень вложенности - файлы json, имя цифры по порядку: `1.json`, `2.json`, `3.json`,...

Файлы отправляются по порядку номеров с паузой `MSG_PAUSE` из `.env`

Когда файл по номеру подписки не находится:

* Если в `.env` есть параметр `DO_BROADCAST=true` и заполнен адрес донора `WS_DOWNLOAD_DONOR` - будет создано подключение и запрос перенаправлен к нему, а ответ возвращен клиенту
   
   * Если в `.env` есть параметр `SAVE_BROADCASTED_MESSAGES=true` полученные ответы будут записываться как при скачивании моков
   
* Если нет параметра `DO_BROADCAST` ничего не отправляется

## Скачать моки с донора

`npm run loadMocks`

### Описание алгоритма скачивания

1. Подключается к донору WS_DOWNLOAD_DONOR

1. Перебирает все файлы в `src/mock_overrides/messages` и отправляет содержимое каждого файла через `ws.send`

   - Файл должен содержать ключ `t`
   - Файл должен быть ожидаемого подпиской формата

1. Если папка `src/mock_overrides/downloaded` содержит подпапку с названием `t`- она удаляется со вложенными файлами

1. На каждое полученное сообщение

   - Создается папка `src/mock_overrides/downloaded` + `/t`, если ее еще нет
   - Получаем номер последнего созданного файла
   - Если (номер+1) меньше заданного ограничения `WS_DOWNLOAD_MSG_QNT` полученное сообщение записывается в папку, в файл (номер+1).json

1. Подключение держится и сохраняет данные до ограничения `WS_DOWNLOAD_TIME_LOADING` или пока не сбросят

# Настройки

## .env

`PORT=3030`

`MSG_PAUSE=4000 # Пауза между отправлением сообщений с моками`

`WS_DOWNLOAD_DONOR=ws://localhost:3030 # путь ws с которого скачивать моки`

`WS_DOWNLOAD_MSG_QNT=5 # количество скачиваемых сообщений`

`WS_DOWNLOAD_TIME_LOADING=60000 # Время жизни подключения для скачивания`

`DO_BROADCAST=true # Если нет моков - транслировать с донора`

`SAVE_BROADCASTED_MESSAGES=true # Сохранять сообщения при трансляции`

# Подключить сайт к ws мок серверу

`localStorage.setItem('debug:websocket', 'ws://localhost:3030')`
